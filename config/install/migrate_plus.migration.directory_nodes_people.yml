langcode: en
status: true
id: directory_nodes_people
migration_tags:
  - json
migration_group: directory_nodes
label: 'Migration from JSON to Drupal node entities with paragraph references'

source:
  plugin: url
  data_fetcher_plugin: file
  data_parser_plugin: json
  urls: 'public://migrations/directory/scripts/output/240328-processed-aarome-alumni-mm-people.json'
  # urls: 'public://migrations/directory/directory_people.json'
  item_selector: /
  fields:
    - name: id
      selector: id
    - name: title
      selector: title
    - name: fname
      selector: fname
    - name: lname
      selector: lname
    - name: affiliations
      selector: affiliations
    - name: entries
      selector: entries
  ids:
    id:
      type: integer

process:
  type:
    plugin: default_value
    default_value: people

  uid:
    plugin: default_value
    default_value: 19

  # title: title
  title:
    -
      plugin: skip_existing_node
      source: title

  field_people_name/given: fname
  field_people_name/middle: mname
  field_people_name/family: lname
  field_people_source/value:
    plugin: default_value
    default_value: 1

  # Assuming 'field_people_affiliations' is an entity reference field to paragraphs
  field_people_affiliations:
    - plugin: sub_process
      source: affiliations
      process:
        ids:
          - plugin: migration_lookup
            migration:
              - directory_pg_affiliations
            source_ids:
              directory_pg_affiliations:
                - pg_id
        target_id:
          plugin: extract
          source: "@ids"
          index:
            - 0
        target_revision_id:
          plugin: extract
          source: "@ids"
          index:
            - 1

  field_directory_entry:
    - plugin: sub_process
      source: entries
      process:
        ids:
          - plugin: migration_lookup
            migration:
              - directory_pg_entries
            source_ids:
              directory_pg_entries:
                - pg_id
        target_id:
          plugin: extract
          source: "@ids"
          index:
            - 0
        target_revision_id:
          plugin: extract
          source: "@ids"
          index:
            - 1

destination:
  plugin: entity:node
  default_bundle: 'people'

migration_dependencies:
  optional:
    - directory_pg_affiliations
    - directory_pg_entries
